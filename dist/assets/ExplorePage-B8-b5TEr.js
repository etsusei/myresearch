import{_ as He,u as Ee,e as Re,d as Be,r as f,f as $e,c as v,a as n,w as Q,g as K,t as i,b as l,v as ce,F as V,h as Y,n as z,i as ue,j as Z,k as Xe,l as Ve,o as h}from"./index-Hwq3ryd1.js";import{u as Ye}from"./session-DgtO-MH7.js";const ze={class:"explore-page"},Ie={class:"explore-container"},qe={class:"control-panel card"},Fe={class:"panel-title"},Ue=["value"],Oe={class:"panel-title mt-2"},We=["value"],Ne={class:"panel-title mt-2"},De={class:"version-toggle"},Ge=["disabled"],Je={key:0,class:"spinner"},Qe={key:1},Ke={key:0,class:"analysis-info mt-2"},Ze={class:"info-text"},je={class:"info-text"},et={class:"info-text"},tt={class:"player-section mt-3"},st={class:"panel-title"},ot={class:"song-id"},nt={class:"player-controls"},at=["disabled"],lt=["disabled"],it={class:"time-display"},rt={key:1,class:"cluster-reps mt-3"},ct={class:"panel-title"},ut=["onClick"],dt={class:"cluster-song"},pt={class:"plot-area"},vt={class:"plot-header"},ht={class:"plot-title"},ft={class:"plot-subtitle"},mt={class:"plot-wrapper"},_t={class:"y-axis-outer"},yt=["innerHTML"],gt={class:"y-axis-name"},xt=["innerHTML"],bt={class:"x-axis-container"},kt={class:"axis-pole left"},wt={class:"axis-name"},Ct={class:"axis-pole right"},Pt={class:"questionnaire-panel card"},St={class:"panel-title"},Tt={class:"question-text"},Mt={class:"likert-group"},At=["onClick"],Lt={key:0,class:"final-questions mt-3"},Ht={class:"panel-title highlight"},Et={class:"preference-options"},Rt=["onClick"],Bt={class:"feedback-section mt-2"},$t={class:"form-label"},Xt=["placeholder"],Vt=["disabled"],Yt={key:0,class:"spinner"},zt={key:1},It={key:2},qt={key:3},de="",Ft="https://neon.zeabur.app",Ut={__name:"ExplorePage",setup(Ot){const{t:p,locale:pe}=Ee(),j=Be(),u=Ye(),O=f(null),ee=f(null),A=f(null),I=f([]),q=f([]),ve=[{id:"discoverability"},{id:"serendipity"},{id:"coherence"},{id:"satisfaction"}],he=["a","b","same"],x=f(""),b=f(""),W=f(!1),B=f(null),P=f([]),$=f([]),S=f({x:"PC1",xR:"0.00",xLow:"",xHigh:"",y:"PC2",yR:"0.00",yLow:"",yHigh:""}),C=f(null),M=f(!1),G=f(0),N=f(0),X=f(30),D=f({minX:-6,maxX:6,minY:-5,maxY:5}),te=["#667eea","#f59e0b","#10b981","#ef4444","#8b5cf6","#06b6d4"];function se(s){return te[s%te.length]}const fe=Z(()=>{const s=u.responses.versionA,o=u.responses.versionB,e=["discoverability","serendipity","coherence","satisfaction"],r=e.every(a=>s[a]!==void 0),t=e.every(a=>o[a]!==void 0);return r&&t}),me=Z(()=>S.value.yHigh.replace(/ \/ /g,"<br>")),_e=Z(()=>S.value.yLow.replace(/ \/ /g,"<br>"));async function ye(){try{const o=await(await fetch(`${de}/api/info`)).json();I.value=o.genres,q.value=o.emotions,I.value.length>0&&(x.value=I.value[0]),q.value.length>0&&(b.value=q.value[0])}catch(s){console.error("Failed to load info:",s),I.value=["POP","Rock/Metal","Electronic","EDM","Jazz"],q.value=["Happiness","Excitement","Healing","Sadness","Nostalgia"],x.value="POP",b.value="Happiness"}}function oe(s){u.currentVersion=s,x.value&&b.value&&J()}async function J(){if(!(!x.value||!b.value)){W.value=!0,u.currentGenre=x.value,u.currentEmotion=b.value;try{const o=await(await fetch(`${de}/api/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({genre:x.value,emotion:b.value,version:u.currentVersion,version_mapping:u.versionMapping,auto_k:!0,manual_k:3})})).json();if(o.error){console.error("Analysis error:",o.error),P.value=[],$.value=[],B.value={count:o.count||0,k:0,error:o.error},F();return}if(B.value=o,P.value=o.points,$.value=o.cluster_reps.map((e,r)=>({...e,color:se(r)})),o.axis){const e=pe.value,r=a=>typeof a=="string"?a:(a==null?void 0:a[e])||(a==null?void 0:a.en)||"PC",t=(a,m)=>{if(!a)return"";const c=a[e]||a.en||a,y=(c==null?void 0:c[m])||c||"";return typeof y=="string"?y.split(`
`).join(" / "):""};S.value={x:r(o.axis.x.label),xR:o.axis.x.r||"0.00",xLow:t(o.axis.x.polarity,"low"),xHigh:t(o.axis.x.polarity,"high"),y:r(o.axis.y.label),yR:o.axis.y.r||"0.00",yLow:t(o.axis.y.polarity,"low"),yHigh:t(o.axis.y.polarity,"high")}}if(P.value.length>0){const e=P.value.map(a=>a.x),r=P.value.map(a=>a.y),t=.5;D.value={minX:Math.min(...e)-t,maxX:Math.max(...e)+t,minY:Math.min(...r)-t,maxY:Math.max(...r)+t}}u.trackExploration(),await Ve(),F()}catch(s){console.error("Analysis failed:",s)}finally{W.value=!1}}}function F(){var re;const s=O.value,o=ee.value;if(!s||!o)return;const e=o.getBoundingClientRect(),r=window.devicePixelRatio||1;s.width=e.width*r,s.height=e.height*r,s.style.width=e.width+"px",s.style.height=e.height+"px";const t=s.getContext("2d");t.scale(r,r);const a=e.width,m=e.height,c={left:50,right:20,top:20,bottom:40},y=a-c.left-c.right,k=m-c.top-c.bottom;t.fillStyle="rgba(15, 15, 26, 0.9)",t.fillRect(0,0,a,m),t.strokeStyle="rgba(255, 255, 255, 0.1)",t.lineWidth=1;for(let d=0;d<=10;d++){const _=c.left+d/10*y;t.beginPath(),t.moveTo(_,c.top),t.lineTo(_,m-c.bottom),t.stroke()}for(let d=0;d<=10;d++){const _=c.top+d/10*k;t.beginPath(),t.moveTo(c.left,_),t.lineTo(a-c.right,_),t.stroke()}if(t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2,t.beginPath(),t.moveTo(c.left,m-c.bottom),t.lineTo(a-c.right,m-c.bottom),t.moveTo(c.left,m-c.bottom),t.lineTo(c.left,c.top),t.stroke(),P.value.length===0){t.fillStyle="rgba(255, 255, 255, 0.5)",t.font="14px Inter",t.textAlign="center",t.fillText(((re=B.value)==null?void 0:re.error)||"No data",a/2,m/2);return}const{minX:g,maxX:T,minY:w,maxY:H}=D.value;function E(d){return c.left+(d-g)/(T-g)*y}function U(d){return m-c.bottom-(d-w)/(H-w)*k}for(const d of P.value){const _=E(d.x),R=U(d.y);t.beginPath(),t.arc(_,R,5,0,Math.PI*2),t.fillStyle=d.color,t.fill(),d.id===C.value&&(t.strokeStyle="white",t.lineWidth=2,t.stroke())}for(let d=0;d<$.value.length;d++){const _=$.value[d],R=E(_.x),Le=U(_.y);ge(t,R,Le,5,12,6,_.color)}t.fillStyle="rgba(255, 255, 255, 0.5)",t.font="10px Inter",t.textAlign="center";const Me=(T-g)/5;for(let d=0;d<=5;d++){const _=g+d*Me,R=E(_);t.fillText(_.toFixed(1),R,m-c.bottom+15)}t.textAlign="right";const Ae=(H-w)/5;for(let d=0;d<=5;d++){const _=w+d*Ae,R=U(_);t.fillText(_.toFixed(1),c.left-5,R+3)}}function ge(s,o,e,r,t,a,m){let c=Math.PI/2*3,y=o,k=e;const g=Math.PI/r;s.beginPath(),s.moveTo(o,e-t);for(let T=0;T<r;T++)y=o+Math.cos(c)*t,k=e+Math.sin(c)*t,s.lineTo(y,k),c+=g,y=o+Math.cos(c)*a,k=e+Math.sin(c)*a,s.lineTo(y,k),c+=g;s.lineTo(o,e-t),s.closePath(),s.fillStyle=m,s.fill(),s.strokeStyle="white",s.lineWidth=1.5,s.stroke()}function xe(s){const e=O.value.getBoundingClientRect(),r=s.clientX-e.left,t=s.clientY-e.top,a={left:50,right:20,top:20,bottom:40},m=e.width-a.left-a.right,c=e.height-a.top-a.bottom,{minX:y,maxX:k,minY:g,maxY:T}=D.value;for(const w of P.value){const H=a.left+(w.x-y)/(k-y)*m,E=e.height-a.bottom-(w.y-g)/(T-g)*c;if(Math.abs(r-H)<10&&Math.abs(t-E)<10){ae(w.id);break}}}let ne=0,L=0;async function ae(s){C.value=s,u.logExploration("play",s);try{const o=`${Ft}/song/url?id=${s}`;console.log("Fetching music URL:",o);const r=await(await fetch(o)).json();if(console.log("Music API response:",r),r.data&&r.data[0]&&r.data[0].url){const t=A.value;t.src=r.data[0].url,t.onloadedmetadata=()=>{ne=t.duration,L=Math.max(0,ne/2-15),t.currentTime=L,X.value=30,t.play(),M.value=!0,F()},t.load()}else console.error("No audio URL found for:",s)}catch(o){console.error("Failed to get music URL:",o)}}function be(s){const o=O.value,e=o.getBoundingClientRect(),r=s.clientX-e.left,t=s.clientY-e.top,a={left:50,right:20,top:20,bottom:40},m=e.width-a.left-a.right,c=e.height-a.top-a.bottom,{minX:y,maxX:k,minY:g,maxY:T}=D.value;let w=!1;for(const H of P.value){const E=a.left+(H.x-y)/(k-y)*m,U=e.height-a.bottom-(H.y-g)/(T-g)*c;if(Math.abs(r-E)<10&&Math.abs(t-U)<10){w=!0;break}}o.style.cursor=w?"pointer":"default"}function ke(){const s=A.value;!s||!C.value||(M.value?(s.pause(),M.value=!1):((s.currentTime>=L+30||s.currentTime<L)&&(s.currentTime=L),s.play(),M.value=!0))}function le(){const s=A.value;s&&(s.pause(),s.currentTime=0,M.value=!1,G.value=0,N.value=0)}function we(){const s=A.value;if(!s)return;const o=s.currentTime-L;N.value=Math.max(0,o),X.value>0&&(G.value=N.value/X.value*100),o>=30&&(s.pause(),M.value=!1,u.logPlayback(C.value,30,!0))}function Ce(){const s=A.value;s&&(X.value=Math.min(s.duration,30))}function Pe(){M.value=!1,u.logPlayback(C.value,X.value,!0)}function Se(s){const o=A.value;if(!o||!C.value)return;const e=s.target.getBoundingClientRect(),t=(s.clientX-e.left)/e.width;o.currentTime=L+t*30}function ie(s){const o=Math.floor(s/60),e=Math.floor(s%60);return`${o}:${e.toString().padStart(2,"0")}`}async function Te(){await u.submitSession()&&setTimeout(()=>{j.push("/complete")},2e3)}return Re(async()=>{if(!u.userId){j.push("/");return}await ye(),x.value&&b.value&&await J(),window.addEventListener("resize",F)}),$e(()=>{window.removeEventListener("resize",F),le()}),(s,o)=>(h(),v("div",ze,[n("div",Ie,[n("aside",qe,[n("h3",Fe,i(l(p)("explorer.selectGenre")),1),Q(n("select",{"onUpdate:modelValue":o[0]||(o[0]=e=>x.value=e),class:"form-select"},[(h(!0),v(V,null,Y(I.value,e=>(h(),v("option",{key:e,value:e},i(l(p)(`genres.${e}`)||e),9,Ue))),128))],512),[[ce,x.value]]),n("h3",Oe,i(l(p)("explorer.selectEmotion")),1),Q(n("select",{"onUpdate:modelValue":o[1]||(o[1]=e=>b.value=e),class:"form-select"},[(h(!0),v(V,null,Y(q.value,e=>(h(),v("option",{key:e,value:e},i(l(p)(`emotions.${e}`)||e),9,We))),128))],512),[[ce,b.value]]),n("h3",Ne,i(l(p)("explorer.selectVersion")),1),n("div",De,[n("button",{class:z(["version-btn",{active:l(u).currentVersion==="A"}]),onClick:o[2]||(o[2]=e=>oe("A"))},i(l(p)("common.versionA")),3),n("button",{class:z(["version-btn",{active:l(u).currentVersion==="B"}]),onClick:o[3]||(o[3]=e=>oe("B"))},i(l(p)("common.versionB")),3)]),n("button",{class:"btn btn-primary mt-2 analyze-btn",onClick:J,disabled:W.value},[W.value?(h(),v("span",Je)):(h(),v("span",Qe,i(l(p)("common.analyze")),1))],8,Ge),B.value?(h(),v("div",Ke,[n("p",Ze,i(x.value)+" + "+i(b.value),1),n("p",je,i(l(p)("common.total")||"Total")+": "+i(B.value.count)+" "+i(l(p)("common.songs")||"songs"),1),n("p",et,"K = "+i(B.value.k),1)])):K("",!0),n("div",tt,[n("h3",st,i(l(p)("explorer.nowPlaying")),1),n("p",ot,i(C.value||"-"),1),n("audio",{ref_key:"audioPlayer",ref:A,onTimeupdate:we,onEnded:Pe,onLoadedmetadata:Ce},null,544),n("div",nt,[n("button",{class:"player-btn",onClick:ke,disabled:!C.value},i(M.value?"⏸":"▶"),9,at),n("button",{class:"player-btn",onClick:le,disabled:!C.value},"■",8,lt)]),n("div",{class:"progress-bar",onClick:Se},[n("div",{class:"progress-fill",style:ue({width:G.value+"%"})},null,4)]),n("div",it,i(ie(N.value))+" / "+i(ie(X.value)),1)]),$.value.length>0?(h(),v("div",rt,[n("h3",ct,i(l(p)("explorer.clusterReps")),1),(h(!0),v(V,null,Y($.value,(e,r)=>(h(),v("div",{key:r,class:z(["cluster-rep-item",{active:C.value===e.id}]),onClick:t=>ae(e.id)},[n("span",{class:"cluster-label",style:ue({background:se(r)})},"C"+i(r+1),5),n("span",dt,i(e.id),1)],10,ut))),128))])):K("",!0)]),n("main",pt,[n("div",vt,[n("span",ht,i(x.value)+" - "+i(b.value),1),n("span",ft,"("+i(l(p)("explorer.clickToPlay")||"Click any point to Play")+")",1)]),n("div",mt,[n("div",_t,[n("div",{class:"y-pole-top",innerHTML:me.value},null,8,yt),n("div",gt,i(S.value.y)+" (r≈"+i(S.value.yR)+")",1),n("div",{class:"y-pole-bottom",innerHTML:_e.value},null,8,xt)]),n("div",{class:"plot-container",ref_key:"plotContainer",ref:ee},[n("canvas",{ref_key:"plotCanvas",ref:O,onClick:xe,onMousemove:be},null,544)],512)]),n("div",bt,[n("span",kt,i(S.value.xLow),1),n("span",wt,i(S.value.x)+" (r≈"+i(S.value.xR)+")",1),n("span",Ct,i(S.value.xHigh),1)])]),n("aside",Pt,[n("h3",St,i(l(p)("questionnaire.rateExperience"))+" ("+i(l(p)("common.version"+l(u).currentVersion))+")",1),(h(),v(V,null,Y(ve,e=>n("div",{class:"question-item",key:e.id},[n("p",Tt,i(l(p)(`questionnaire.${e.id}`)),1),n("div",Mt,[(h(),v(V,null,Y(5,r=>n("button",{key:r,class:z(["likert-option",{selected:l(u).responses[`version${l(u).currentVersion}`][e.id]===r}]),onClick:t=>l(u).setResponse(e.id,r)},i(r),11,At)),64))])])),64)),fe.value?(h(),v("div",Lt,[n("h3",Ht,i(l(p)("questionnaire.preference")),1),n("div",Et,[(h(),v(V,null,Y(he,e=>n("button",{key:e,class:z(["preference-btn",{selected:l(u).responses.final.preference===e}]),onClick:r=>l(u).setFinalResponse("preference",e)},i(l(p)(`questionnaire.preferenceOptions.${e}`)),11,Rt)),64))]),n("div",Bt,[n("label",$t,i(l(p)("questionnaire.feedback")),1),Q(n("textarea",{"onUpdate:modelValue":o[4]||(o[4]=e=>l(u).responses.final.feedback=e),class:"feedback-input",placeholder:l(p)("questionnaire.feedbackPlaceholder"),rows:"3"},null,8,Xt),[[Xe,l(u).responses.final.feedback]])]),n("button",{class:z(["btn submit-btn mt-2",{"btn-primary":!l(u).isSubmitting&&l(u).submitStatus===null,"btn-success":l(u).submitStatus==="success","btn-error":l(u).submitStatus==="error"}]),disabled:!l(u).isComplete||l(u).isSubmitting,onClick:Te},[l(u).isSubmitting?(h(),v("span",Yt)):l(u).submitStatus==="success"?(h(),v("span",zt,"✓ "+i(l(p)("common.submitSuccess")),1)):l(u).submitStatus==="error"?(h(),v("span",It,"✗ "+i(l(p)("common.submitError")),1)):(h(),v("span",qt,i(l(p)("common.submit")),1))],10,Vt)])):K("",!0)])])]))}},Dt=He(Ut,[["__scopeId","data-v-f53911a6"]]);export{Dt as default};
