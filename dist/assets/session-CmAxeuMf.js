import{m as V,r as a}from"./index-CdMgmJf8.js";const H=V("session",()=>{const c=a(null),w=a("zh"),g=a(null),m=a(null),v=a({A:null,B:null}),d=a("A"),k=a(null),S=a(null),r=a("guided"),L=a(0),y=a("welcome"),h=a(!1),f=a(null),s=a({}),l=a({}),u=a({songId:null,startTime:null,contextId:null});function U(){c.value=crypto.randomUUID(),g.value=new Date().toISOString();const e=Math.random()<.5;v.value={A:e?"GT":"Model",B:e?"Model":"GT"},console.log("Session initialized:",{userId:c.value,versionMapping:v.value})}function i(){if(y.value==="final")return"final";const e=k.value||"Unknown",n=S.value||"Unknown",t=d.value,o=r.value;return`${e}_${n}_${t}_${o}`}function b(){const e=i();s.value[e]||(s.value[e]={genre:k.value,emotion:S.value,version:d.value,taskType:r.value,events:[],path:[],likedSongs:[],responses:{}})}function p(e,n={}){b();const t=i(),o={type:e,timestamp:Date.now(),...n};s.value[t].events.push(o)}function C(e,n,t){if(p("click",{songId:e,x:n,y:t}),r.value==="free"){b();const o=i();s.value[o].path.push({songId:e,x:n,y:t,timestamp:Date.now()})}}function M(e){u.value.songId&&D(),u.value={songId:e,startTime:Date.now(),contextId:i()},p("play_start",{songId:e})}function D(){if(!u.value.songId)return;const e=(Date.now()-u.value.startTime)/1e3,n=u.value.songId,t=u.value.contextId,o={type:"play_end",timestamp:Date.now(),songId:n,duration:e};if(s.value[t]&&s.value[t].events.push(o),l.value[n]||(l.value[n]={duration:0,timestamp:Date.now()}),l.value[n].duration+=e,t.includes("_free")){const T=s.value[t];if(T&&T.path){const x=T.path.find(_=>_.songId===n&&!_.duration);x&&(x.duration=e)}}u.value={songId:null,startTime:null}}function R(e){b();const n=i(),t=s.value[n];t.likedSongs||(t.likedSongs=[]);const o=t.likedSongs.indexOf(e);o===-1?(t.likedSongs.push(e),p("like",{songId:e})):(t.likedSongs.splice(o,1),p("unlike",{songId:e}))}function $(e){const n=i(),t=s.value[n];return t&&t.likedSongs?t.likedSongs.includes(e):!1}function j(){const e=i(),n=s.value[e];return n&&n.likedSongs?n.likedSongs.length:0}function F(e){const n=l.value[e];return n?n.duration<5?"skipped":"listened":"unheard"}function P(){return Object.values(l.value).filter(e=>e.duration>=5).length}function O(){return y.value==="final"?"final":r.value==="free"?`Summary_${d.value}_free`:i()}function E(e,n){const t=O();s.value[t]||(s.value[t]={genre:"Mixed",emotion:"Mixed",version:d.value,taskType:r.value,events:[],path:[],likedSongs:[],responses:{}}),s.value[t].responses[e]=n}function G(e){const n=O();if(s.value[n]&&s.value[n].responses)return s.value[n].responses[e]}function A(e,n){s.value.final||(s.value.final={responses:{}}),s.value.final.responses[e]=n}function B(e){if(s.value.final&&s.value.final.responses)return s.value.final.responses[e]}function J(){return!0}function N(){return!0}function I(){return m.value=new Date().toISOString(),{sessionId:crypto.randomUUID(),userId:c.value,language:w.value,startTime:g.value,endTime:m.value,versionMapping:v.value,data:s.value}}function z(){const e=I(),n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t=URL.createObjectURL(n),o=document.createElement("a");o.href=t,o.download=`session_${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}_${c.value.slice(0,8)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t)}async function K(){h.value=!0,f.value=null;try{const e=I(),n=JSON.parse(localStorage.getItem("submissions")||"[]");n.push(e),localStorage.setItem("submissions",JSON.stringify(n));try{await fetch("/api/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_data:e})})}catch(t){console.warn("Backend submit failed, data saved locally:",t)}return f.value="success",!0}catch(e){return console.error("Submit error:",e),f.value="error",!1}finally{h.value=!1}}function Q(){l.value={}}return{userId:c,language:w,startTime:g,endTime:m,versionMapping:v,currentVersion:d,currentGenre:k,currentEmotion:S,currentTaskType:r,explorationsCount:L,taskStep:y,sessionData:s,listenedSongs:l,currentPlayback:u,isSubmitting:h,submitStatus:f,initSession:U,recordClick:C,recordPlayStart:M,recordPlayEnd:D,toggleLike:R,isLiked:$,getLikedCount:j,getListenedState:F,getListenedCount:P,setResponse:E,getResponse:G,setFinalResponse:A,getFinalResponse:B,canProceedFromGuided:J,canProceedFromFree:N,getSessionData:I,downloadSessionData:z,submitSession:K,resetListenedForTask:Q}});export{H as u};
